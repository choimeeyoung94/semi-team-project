<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mybatis.mapper.chatMapper">
  
<!-- 내가 로그인 해서 내가 채팅한 모든 사용자들과의 마지막 메시지만 불러오는 코드 -->  
<select id="getChatList" resultType="org.puppit.model.dto.ChatListDTO">
    SELECT
    r.room_id                  AS roomId,
    p.product_id               AS productId,
    p.product_name             AS productName,
    p.product_price            AS productPrice,
    -- 상대방 정보 (내가 sender면 receiver, 내가 receiver면 sender)
    CASE
        WHEN c.chat_sender = #{userId} THEN receiver.user_id
        ELSE sender.user_id
    END                        AS otherUserId,
    CASE
        WHEN c.chat_sender = #{userId} THEN receiver.account_id
        ELSE sender.account_id
    END                        AS otherAccountId,
    CASE
        WHEN c.chat_sender = #{userId} THEN receiver.user_name
        ELSE sender.user_name
    END                        AS otherUserName,
    -- 마지막 메시지 정보
    c.chat_message             AS lastMessage,
    c.chat_created_at          AS lastMessageAt,
    c.chat_sender              AS lastMessageSenderId,
    sender.account_id          AS lastMessageSenderAccountId,
    sender.user_name           AS lastMessageSenderName,
    c.chat_receiver            AS lastMessageReceiverId,
    receiver.account_id        AS lastMessageReceiverAccountId,
    receiver.user_name         AS lastMessageReceiverName
FROM (
    SELECT chat_room_id, MAX(message_id) AS max_message_id
    FROM chat
    WHERE chat_sender = #{userId} OR chat_receiver = #{userId}
    GROUP BY chat_room_id
) last_msg
JOIN chat c ON c.chat_room_id = last_msg.chat_room_id AND c.message_id = last_msg.max_message_id
JOIN room r ON c.chat_room_id = r.room_id
JOIN product p ON r.product_id = p.product_id
JOIN user sender ON c.chat_sender = sender.user_id
JOIN user receiver ON c.chat_receiver = receiver.user_id
ORDER BY c.chat_created_at DESC
</select>
  
  <select id="getTotalChatCount" parameterType="int" resultType="int">
  	    SELECT COUNT(*)
    FROM chat
    WHERE chat_room_id = #{roomId}
      AND (
        (chat_sender = #{buyerId} AND chat_receiver = #{sellerId})
        OR (chat_sender = #{sellerId} AND chat_receiver = #{buyerId})
      )
  
  </select>
  
  <select id="getBuyerToSellerCount" parameterType="map" resultType="int">
	  SELECT COUNT(*)
	  FROM chat
	  WHERE chat_room_id = #{roomId}
	    AND chat_sender = #{buyerId}
	    AND chat_receiver = #{sellerId}
	</select>
  
  
 <select id="getChatMyProfileImage" parameterType="String"  resultType="org.puppit.model.dto.ChaListProfileImageDTO">
  	  SELECT
    c.chat_room_id,
    p.product_name,
    c.chat_message,
    sender.account_id AS chat_sender_account_id,
    receiver.account_id AS chat_receiver_account_id,
    sender.profile_image_key AS senderProfileImageKey,
    receiver.profile_image_key AS receiverProfileImageKey,
    p.seller_id AS product_seller_id,
    seller.account_id AS product_seller_account_id,
    seller.profile_image_key AS sellerProfileImageKey,
    -- 상대방 프로필 이미지 키 (로그인 계정 기준)
    CASE 
        WHEN #{accountId} = sender.account_id THEN receiver.profile_image_key
        WHEN #{accountId} = receiver.account_id THEN sender.profile_image_key
        ELSE NULL
    END AS otherProfileImageKey
FROM chat c
INNER JOIN room r ON c.chat_room_id = r.room_id
INNER JOIN product p ON r.product_id = p.product_id
LEFT JOIN user sender ON c.chat_sender = sender.user_id
LEFT JOIN user receiver ON c.chat_receiver = receiver.user_id
LEFT JOIN user seller ON p.seller_id = seller.user_id
WHERE sender.account_id = #{accountId}
   OR receiver.account_id = #{accountId}
ORDER BY c.chat_created_at DESC
  
  
  </select>
  
  
  
  
  
</mapper>